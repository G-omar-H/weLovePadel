<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Insights</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" type="image/png" href="assets/favicon/favicon-96x96.png" sizes="96x96">
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #1d4ed8;
            --secondary: #8b5cf6;
            --accent: #f59e0b;
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-card-hover: #1a1a25;
            --text: #e8e8e8;
            --text-muted: #888;
            --border: #2a2a35;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1a0a10 100%);
        }

        .login-screen h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--accent);
        }

        .login-screen p {
            color: var(--text-muted);
            margin-bottom: 20px;
        }

        .login-input {
            padding: 12px 20px;
            font-size: 1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text);
            width: 300px;
            max-width: 100%;
            margin-bottom: 15px;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .login-btn {
            padding: 12px 30px;
            font-size: 1rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(196, 30, 58, 0.4);
        }

        .login-error {
            color: var(--danger);
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        /* Dashboard */
        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--bg-card) 0%, #1a1020 100%);
            border-bottom: 1px solid var(--border);
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-title .icon {
            font-size: 1.8rem;
        }

        .header-title h1 {
            font-size: 1.4rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent) 0%, #fff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-nav {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .nav-link {
            padding: 8px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .nav-link:hover,
        .nav-link.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .refresh-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: var(--secondary);
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .refresh-btn:hover {
            background: #2e7d32;
        }

        .refresh-btn .spinner {
            display: none;
            width: 14px;
            height: 14px;
            border: 2px solid transparent;
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .refresh-btn.loading .spinner {
            display: inline-block;
        }

        .refresh-btn.loading .icon {
            display: none;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Main Content */
        main {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Section Headers */
        .section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        .section-header h2 {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--accent);
        }

        .section-header .badge {
            padding: 4px 10px;
            background: var(--primary);
            border-radius: 12px;
            font-size: 0.75rem;
            color: white;
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-card-hover) 100%);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
        }

        .kpi-card.potential::before {
            background: var(--warning);
        }

        .kpi-card.revenue::before {
            background: var(--success);
        }

        .kpi-card.orders::before {
            background: var(--info);
        }

        .kpi-card.visitors::before {
            background: #8b5cf6;
        }

        .kpi-card.conversion::before {
            background: var(--accent);
        }

        .kpi-card.aov::before {
            background: #06b6d4;
        }

        .kpi-card.shipping::before {
            background: #f97316;
        }

        .kpi-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text);
            line-height: 1.2;
        }

        .kpi-subtitle {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 5px;
        }

        .kpi-trend {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 10px;
        }

        .kpi-trend.up {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }

        .kpi-trend.down {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        /* Grid Layouts */
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .insight-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }

        .insight-card h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 250px;
        }

        .bar-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 100%;
            padding: 10px 0;
            gap: 8px;
        }

        .bar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            max-width: 60px;
        }

        .bar {
            width: 100%;
            max-width: 40px;
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 4px 4px 0 0;
            transition: all 0.3s ease;
            min-height: 4px;
        }

        .bar:hover {
            background: linear-gradient(180deg, var(--accent) 0%, #b8962f 100%);
            transform: scaleX(1.1);
        }

        .bar-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 8px;
            text-align: center;
        }

        .bar-value {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 5px;
        }

        /* Horizontal Bar Chart */
        .h-bar-chart {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .h-bar-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .h-bar-label {
            min-width: 100px;
            font-size: 0.85rem;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .h-bar-track {
            flex: 1;
            height: 24px;
            background: var(--bg-dark);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .h-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            transition: width 0.5s ease;
        }

        .h-bar-value {
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* Donut Chart */
        .donut-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .donut-chart {
            width: 160px;
            height: 160px;
            position: relative;
        }

        .donut-chart svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .donut-chart circle {
            fill: none;
            stroke-width: 20;
        }

        .donut-bg {
            stroke: var(--bg-dark);
        }

        .donut-segment {
            stroke-linecap: round;
            transition: stroke-dasharray 0.5s ease;
        }

        .donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .donut-center-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
        }

        .donut-center-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .donut-legend {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .legend-label {
            font-size: 0.85rem;
            color: var(--text);
        }

        .legend-value {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-left: auto;
        }

        /* Stat List */
        .stat-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: var(--bg-dark);
            border-radius: 8px;
            border-left: 3px solid var(--primary);
        }

        .stat-item:nth-child(2) {
            border-color: var(--secondary);
        }

        .stat-item:nth-child(3) {
            border-color: var(--accent);
        }

        .stat-item:nth-child(4) {
            border-color: var(--info);
        }

        .stat-item:nth-child(5) {
            border-color: #8b5cf6;
        }

        .stat-item-label {
            font-size: 0.9rem;
            color: var(--text);
        }

        .stat-item-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent);
        }

        /* Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 12px;
            background: var(--bg-dark);
            color: var(--text-muted);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--border);
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }

        .data-table tr:hover td {
            background: var(--bg-card-hover);
        }

        /* Funnel */
        .funnel {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 10px 0;
        }

        .funnel-step {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .funnel-bar {
            height: 40px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 4px;
            display: flex;
            align-items: center;
            padding: 0 15px;
            transition: width 0.5s ease;
            min-width: 80px;
        }

        .funnel-step:nth-child(1) .funnel-bar {
            background: linear-gradient(90deg, var(--info) 0%, #2563eb 100%);
        }

        .funnel-step:nth-child(2) .funnel-bar {
            background: linear-gradient(90deg, var(--secondary) 0%, #166534 100%);
        }

        .funnel-step:nth-child(3) .funnel-bar {
            background: linear-gradient(90deg, var(--warning) 0%, #d97706 100%);
        }

        .funnel-step:nth-child(4) .funnel-bar {
            background: linear-gradient(90deg, var(--success) 0%, #16a34a 100%);
        }

        .funnel-bar-text {
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .funnel-info {
            flex: 1;
        }

        .funnel-label {
            font-size: 0.9rem;
            color: var(--text);
            font-weight: 500;
        }

        .funnel-rate {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Metric Grid */
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .metric-item {
            text-align: center;
            padding: 15px;
            background: var(--bg-dark);
            border-radius: 8px;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }

        .metric-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 5px;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 15, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            margin-top: 20px;
            color: var(--text-muted);
        }

        /* Last Updated */
        .last-updated {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            width: 44px;
            height: 44px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 1.2rem;
            cursor: pointer;
            align-items: center;
            justify-content: center;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-wrap: wrap;
            }

            .mobile-menu-toggle {
                display: flex;
            }

            .header-nav {
                display: none;
                width: 100%;
                flex-direction: column;
                gap: 8px;
                margin-top: 12px;
                padding-top: 12px;
                border-top: 1px solid var(--border);
                order: 3;
            }

            .header-nav.active {
                display: flex;
            }

            .nav-link {
                text-align: center;
                padding: 14px 16px;
                min-height: 48px;
            }

            .insights-grid {
                grid-template-columns: 1fr;
            }

            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .kpi-card {
                padding: 16px;
            }

            .kpi-value {
                font-size: 1.25rem;
            }

            .donut-container {
                flex-direction: column;
            }

            .h-bar-label {
                min-width: 80px;
                font-size: 0.75rem;
            }

            .refresh-btn {
                min-height: 44px;
            }
        }

        @media (max-width: 576px) {
            main {
                padding: 12px;
            }

            header {
                padding: 12px;
            }

            .header-title h1 {
                font-size: 1rem;
            }

            .kpi-grid {
                gap: 8px;
            }

            .kpi-card {
                padding: 12px;
            }

            .kpi-value {
                font-size: 1.1rem;
            }

            .kpi-label {
                font-size: 0.7rem;
            }

            .section-card {
                padding: 16px;
            }
        }

        @media (max-width: 400px) {
            .kpi-grid {
                grid-template-columns: 1fr 1fr;
            }

            .nav-link {
                padding: 10px 12px;
                font-size: 0.85rem;
            }
        }
    </style>
</head>

<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <h1>üìà Business Insights</h1>
        <p>Enter the admin password to access business insights</p>
        <div class="login-error" id="loginError" style="display: none;"></div>
        <input type="password" class="login-input" id="passwordInput" placeholder="Enter password" autofocus>
        <button class="login-btn" id="loginBtn">Access Insights</button>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay" style="display: none;">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading business insights...</div>
        </div>

        <header>
            <div class="header-content">
                <div class="header-title">
                    <span class="icon">üìà</span>
                    <h1>Business Insights</h1>
                </div>
                <div class="header-controls">
                    <button class="refresh-btn" id="refreshBtn">
                        <span class="icon">‚Üª</span>
                        <span class="spinner"></span>
                        Refresh
                    </button>
                    <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle navigation">‚ò∞</button>
                </div>
                <a href="analytics-dashboard.html" class="nav-link">üìä Analytics</a>
                <a href="server-logs.html" class="nav-link">üìã Logs</a>
                <a href="orders-dashboard.html" class="nav-link">üì¶ Orders</a>
                <a href="business-insights.html" class="nav-link active">üìà Insights</a>
                <a href="reviews-dashboard.html" class="nav-link">‚≠ê Reviews</a>
                </nav>
            </div>
        </header>

        <main>
            <!-- Key Performance Indicators -->
            <section class="kpi-section">
                <div class="section-header">
                    <h2>üìä Key Performance Indicators</h2>
                    <span class="badge" id="dataPeriod">Today</span>
                </div>
                <div class="kpi-grid">
                    <div class="kpi-card potential">
                        <div class="kpi-label">Potential Revenue</div>
                        <div class="kpi-value" id="potentialRevenue">-</div>
                        <div class="kpi-subtitle">All active orders</div>
                    </div>
                    <div class="kpi-card revenue">
                        <div class="kpi-label">Confirmed Revenue</div>
                        <div class="kpi-value" id="totalRevenue">-</div>
                        <div class="kpi-subtitle">Delivered orders</div>
                    </div>
                    <div class="kpi-card orders">
                        <div class="kpi-label">Total Orders</div>
                        <div class="kpi-value" id="totalOrders">-</div>
                        <div class="kpi-subtitle" id="ordersSubtitle">All time</div>
                    </div>
                    <div class="kpi-card visitors">
                        <div class="kpi-label">Total Visitors</div>
                        <div class="kpi-value" id="totalVisitors">-</div>
                        <div class="kpi-subtitle" id="visitorsSubtitle">Today</div>
                    </div>
                    <div class="kpi-card conversion">
                        <div class="kpi-label">Conversion Rate</div>
                        <div class="kpi-value" id="conversionRate">-</div>
                        <div class="kpi-subtitle">Visitors to orders</div>
                    </div>
                    <div class="kpi-card aov">
                        <div class="kpi-label">Avg Order Value</div>
                        <div class="kpi-value" id="avgOrderValue">-</div>
                        <div class="kpi-subtitle">Per order</div>
                    </div>
                    <div class="kpi-card shipping">
                        <div class="kpi-label">Total Shipping Cost</div>
                        <div class="kpi-value" id="totalShippingCost">-</div>
                        <div class="kpi-subtitle" id="shippingSubtitle">Loading...</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Online Now</div>
                        <div class="kpi-value" id="onlineNow">-</div>
                        <div class="kpi-subtitle">Active visitors</div>
                    </div>
                </div>
            </section>

            <!-- Insights Grid -->
            <div class="insights-grid">
                <!-- Revenue by City -->
                <div class="insight-card">
                    <h3>üèôÔ∏è Revenue by City</h3>
                    <div class="h-bar-chart" id="revenueByCity">
                        <div class="stat-item"><span class="stat-item-label">Loading...</span></div>
                    </div>
                </div>

                <!-- Order Status Distribution -->
                <div class="insight-card">
                    <h3>üìã Order Status</h3>
                    <div class="donut-container" id="orderStatusChart">
                        <div class="stat-item"><span class="stat-item-label">Loading...</span></div>
                    </div>
                </div>

                <!-- Product Performance -->
                <div class="insight-card">
                    <h3>üèÜ Product Performance</h3>
                    <div class="stat-list" id="productPerformance">
                        <div class="stat-item"><span class="stat-item-label">Loading...</span></div>
                    </div>
                </div>

                <!-- Traffic Sources -->
                <div class="insight-card">
                    <h3>üì± Traffic Sources</h3>
                    <div class="h-bar-chart" id="trafficSources">
                        <div class="stat-item"><span class="stat-item-label">Loading...</span></div>
                    </div>
                </div>

                <!-- Device Distribution -->
                <div class="insight-card">
                    <h3>üíª Device Distribution</h3>
                    <div class="donut-container" id="deviceChart">
                        <div class="stat-item"><span class="stat-item-label">Loading...</span></div>
                    </div>
                </div>

                <!-- Conversion Funnel -->
                <div class="insight-card">
                    <h3>üéØ Conversion Funnel</h3>
                    <div class="funnel" id="conversionFunnel">
                        <div class="stat-item"><span class="stat-item-label">Loading...</span></div>
                    </div>
                </div>

                <!-- Top Performing Pages -->
                <div class="insight-card">
                    <h3>üìÑ Top Pages</h3>
                    <div class="stat-list" id="topPages">
                        <div class="stat-item"><span class="stat-item-label">Loading...</span></div>
                    </div>
                </div>

                <!-- Customer Insights -->
                <div class="insight-card">
                    <h3>üë• Customer Insights</h3>
                    <div class="metric-grid" id="customerInsights">
                        <div class="stat-item"><span class="stat-item-label">Loading...</span></div>
                    </div>
                </div>
            </div>

            <!-- Hourly Traffic -->
            <div class="insight-card" style="margin-bottom: 30px;">
                <h3>üìà Hourly Traffic Today</h3>
                <div class="chart-container">
                    <div class="bar-chart" id="hourlyChart">
                        <div class="stat-item"><span class="stat-item-label">Loading...</span></div>
                    </div>
                </div>
            </div>

            <!-- Recent Orders Table -->
            <div class="insight-card">
                <h3>üõí Recent Orders</h3>
                <div style="overflow-x: auto;">
                    <table class="data-table" id="recentOrdersTable">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Customer</th>
                                <th>City</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Products</th>
                            </tr>
                        </thead>
                        <tbody id="recentOrdersBody">
                            <tr>
                                <td colspan="6" style="text-align: center;">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="last-updated" id="lastUpdated">
                Last updated: -
            </div>
        </main>
    </div>

    <script>
        // Configuration
        const ANALYTICS_API = '/api/analytics/summary';
        const SENDIT_API_BASE = 'https://app.sendit.ma/api/v1';
        const SENDIT_PUBLIC_KEY = '9a8a46843e3b20b922f67690ff1f27e0';
        const SENDIT_SECRET_KEY = 'k1S94ZRQ4AFpMDoL2UQktsXymcAfFVyG';

        let adminPassword = '';
        let authToken = localStorage.getItem('sendit_auth_token') || null;
        let analyticsData = null;
        let ordersData = [];

        // DOM Elements
        const loginScreen = document.getElementById('loginScreen');
        const dashboard = document.getElementById('dashboard');
        const passwordInput = document.getElementById('passwordInput');
        const loginBtn = document.getElementById('loginBtn');
        const loginError = document.getElementById('loginError');
        const refreshBtn = document.getElementById('refreshBtn');
        const loadingOverlay = document.getElementById('loadingOverlay');

        // Login
        loginBtn.addEventListener('click', attemptLogin);
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') attemptLogin();
        });

        async function attemptLogin() {
            const password = passwordInput.value.trim();
            if (!password) return;

            try {
                const response = await fetch(`${ANALYTICS_API}?password=${encodeURIComponent(password)}&period=today`);
                const data = await response.json();

                if (data.error) {
                    loginError.textContent = 'Invalid password. Please try again.';
                    loginError.style.display = 'block';
                    passwordInput.value = '';
                    return;
                }

                adminPassword = password;
                analyticsData = data;
                loginScreen.style.display = 'none';
                dashboard.classList.add('active');
                loadAllData();
            } catch (error) {
                loginError.textContent = 'Error connecting to server.';
                loginError.style.display = 'block';
            }
        }

        // Refresh
        refreshBtn.addEventListener('click', () => {
            refreshBtn.classList.add('loading');
            loadAllData().finally(() => {
                refreshBtn.classList.remove('loading');
            });
        });

        // Mobile menu toggle
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const headerNav = document.getElementById('headerNav');
        if (mobileMenuToggle && headerNav) {
            mobileMenuToggle.addEventListener('click', () => {
                headerNav.classList.toggle('active');
                mobileMenuToggle.textContent = headerNav.classList.contains('active') ? '‚úï' : '‚ò∞';
            });
        }

        // Sendit Authentication
        async function loginToSendit() {
            try {
                const response = await fetch(`${SENDIT_API_BASE}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        public_key: SENDIT_PUBLIC_KEY,
                        secret_key: SENDIT_SECRET_KEY
                    })
                });
                const data = await response.json();
                if (data.success && data.data && data.data.token) {
                    authToken = data.data.token;
                    localStorage.setItem('sendit_auth_token', authToken);
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Sendit login error:', error);
                return false;
            }
        }

        // Fetch Orders
        async function fetchOrders() {
            if (!authToken) {
                const loggedIn = await loginToSendit();
                if (!loggedIn) return [];
            }

            try {
                let allOrders = [];
                let currentPage = 1;
                let hasMore = true;

                while (hasMore) {
                    const response = await fetch(`${SENDIT_API_BASE}/deliveries?page=${currentPage}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Accept': 'application/json'
                        }
                    });

                    if (response.status === 401) {
                        authToken = null;
                        return fetchOrders();
                    }

                    const data = await response.json();
                    if (data.success && data.data) {
                        let orders = Array.isArray(data.data) ? data.data : Object.values(data.data);
                        orders = orders.filter(o => o && typeof o === 'object' && o.code);
                        allOrders.push(...orders);
                        hasMore = currentPage < (data.last_page || 1);
                        currentPage++;
                    } else {
                        hasMore = false;
                    }
                }
                return allOrders;
            } catch (error) {
                console.error('Error fetching orders:', error);
                return [];
            }
        }

        // Cache for order details (persists across page sessions)
        const orderDetailsCache = new Map();
        const CACHE_KEY = 'storename_order_details_cache';

        // Load cache from localStorage
        function loadOrderCache() {
            try {
                const cached = localStorage.getItem(CACHE_KEY);
                if (cached) {
                    const { data, timestamp } = JSON.parse(cached);
                    // Cache valid for 1 hour
                    if (Date.now() - timestamp < 3600000) {
                        Object.entries(data).forEach(([k, v]) => orderDetailsCache.set(k, v));
                        console.log(`üì¶ Loaded ${orderDetailsCache.size} cached order details`);
                    }
                }
            } catch (e) { }
        }
        loadOrderCache();

        // Save cache to localStorage
        function saveOrderCache() {
            try {
                const data = {};
                orderDetailsCache.forEach((v, k) => data[k] = v);
                localStorage.setItem(CACHE_KEY, JSON.stringify({ data, timestamp: Date.now() }));
            } catch (e) { }
        }

        // Fetch Order Details with caching
        async function fetchOrderDetail(code) {
            // Check cache first
            if (orderDetailsCache.has(code)) {
                return orderDetailsCache.get(code);
            }

            if (!authToken) {
                await loginToSendit();
            }
            try {
                const response = await fetch(`${SENDIT_API_BASE}/deliveries/${code}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Accept': 'application/json'
                    }
                });
                if (response.status === 401) {
                    authToken = null;
                    await loginToSendit();
                    return fetchOrderDetail(code);
                }
                const data = await response.json();
                if (data.success && data.data) {
                    // Cache the result
                    orderDetailsCache.set(code, data.data);
                    return data.data;
                }
                return null;
            } catch (error) {
                console.error(`Error fetching order ${code}:`, error);
                return null;
            }
        }

        // Fetch All Shipping Fees (optimized with caching)
        async function fetchAllShippingFees() {
            if (ordersData.length === 0) return 0;

            // Update UI to show loading
            document.getElementById('totalShippingCost').textContent = '...';
            document.getElementById('shippingSubtitle').textContent = 'Calculating...';

            let totalFee = 0;
            let fetchedCount = 0;
            let cachedCount = 0;

            // First, count cached fees
            ordersData.forEach(order => {
                if (orderDetailsCache.has(order.code)) {
                    const cached = orderDetailsCache.get(order.code);
                    if (cached && cached.fee) {
                        totalFee += parseFloat(cached.fee) || 0;
                    }
                    cachedCount++;
                    fetchedCount++;
                }
            });

            // Get uncached orders
            const uncachedOrders = ordersData.filter(o => !orderDetailsCache.has(o.code));

            // Update progress with cached data
            if (cachedCount > 0) {
                document.getElementById('shippingSubtitle').textContent =
                    `${fetchedCount}/${ordersData.length} (${cachedCount} cached)`;
            }

            // Fetch uncached in larger batches (faster)
            const batchSize = 10;
            for (let i = 0; i < uncachedOrders.length; i += batchSize) {
                const batch = uncachedOrders.slice(i, i + batchSize);
                const promises = batch.map(order => fetchOrderDetail(order.code));
                const results = await Promise.all(promises);

                results.forEach(detail => {
                    if (detail && detail.fee) {
                        totalFee += parseFloat(detail.fee) || 0;
                    }
                    fetchedCount++;
                });

                // Update progress
                document.getElementById('shippingSubtitle').textContent =
                    `${fetchedCount}/${ordersData.length} orders`;

                // Small delay between batches
                if (i + batchSize < uncachedOrders.length) {
                    await new Promise(r => setTimeout(r, 100));
                }
            }

            // Save cache for next time
            saveOrderCache();

            // Update final values
            document.getElementById('totalShippingCost').textContent = formatMAD(totalFee);
            document.getElementById('shippingSubtitle').textContent = `${ordersData.length} orders`;

            return totalFee;
        }

        // Fetch Analytics
        async function fetchAnalytics() {
            try {
                const response = await fetch(`${ANALYTICS_API}?password=${encodeURIComponent(adminPassword)}&period=today`);
                return await response.json();
            } catch (error) {
                console.error('Error fetching analytics:', error);
                return null;
            }
        }

        // Load All Data
        async function loadAllData() {
            loadingOverlay.style.display = 'flex';

            try {
                const [analytics, orders] = await Promise.all([
                    fetchAnalytics(),
                    fetchOrders()
                ]);

                analyticsData = analytics;
                ordersData = orders;

                renderKPIs();
                renderRevenueByCity();
                renderOrderStatus();
                renderProductPerformance();
                renderTrafficSources();
                renderDeviceChart();
                renderConversionFunnel();
                renderTopPages();
                renderCustomerInsights();
                renderHourlyChart();
                renderRecentOrders();

                document.getElementById('lastUpdated').textContent =
                    `Last updated: ${new Date().toLocaleString()}`;

                // Fetch shipping fees in background (doesn't block UI)
                fetchAllShippingFees();

            } catch (error) {
                console.error('Error loading data:', error);
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        // Format Currency
        function formatMAD(amount) {
            return new Intl.NumberFormat('fr-MA', {
                style: 'decimal',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount) + ' MAD';
        }

        // Get status name (Granular)
        function getStatusName(status) {
            if (typeof status === 'number') {
                const numericMap = {
                    1: 'to_prepare',
                    2: 'shipped',
                    3: 'delivered',
                    4: 'returned',
                    5: 'cancelled'
                };
                return numericMap[status] || 'pending';
            }
            const statusMap = {
                'TO_PREPARE': 'to_prepare',
                'READY_TO_SHIP': 'ready_to_ship',
                'pending': 'to_prepare',
                'IN_DELIVERY': 'in_delivery',
                'DELIVERING': 'in_delivery',
                'SHIPPED': 'shipped',
                'POSTPONED': 'postponed',
                'UNREACHABLE': 'unreachable',
                'DELIVERED': 'delivered',
                'delivered': 'delivered',
                'RETURNED': 'returned',
                'REFUSED': 'refused',
                'REJECTED': 'rejected',
                'CANCELED': 'cancelled',
                'CANCELLED': 'cancelled',
                'cancelled': 'cancelled'
            };
            return statusMap[status] || (status ? status.toLowerCase() : 'pending');
        }

        // Render KPIs
        function renderKPIs() {
            // Calculate totals from orders
            const deliveredOrders = ordersData.filter(o => getStatusName(o.status) === 'delivered');

            // Exclude dead statuses from active/potential revenue
            const deadStatuses = ['returned', 'refused', 'rejected', 'cancelled'];
            const activeOrders = ordersData.filter(o => !deadStatuses.includes(getStatusName(o.status)));

            const totalRevenue = deliveredOrders.reduce((sum, o) => sum + parseFloat(o.amount || 0), 0);
            const potentialRevenue = activeOrders.reduce((sum, o) => sum + parseFloat(o.amount || 0), 0);

            const pendingOrders = ordersData.filter(o => {
                const s = getStatusName(o.status);
                return ['to_prepare', 'ready_to_ship', 'pending'].includes(s);
            });

            const avgOrderValue = ordersData.length > 0
                ? ordersData.reduce((sum, o) => sum + parseFloat(o.amount || 0), 0) / ordersData.length
                : 0;

            // Visitors
            const uniqueVisitors = analyticsData?.summary?.uniqueVisitors || 0;
            const allTimeVisitors = analyticsData?.allTime?.totalVisitors || 0;

            // Conversion rate
            const conversionRate = allTimeVisitors > 0
                ? ((ordersData.length / allTimeVisitors) * 100).toFixed(2)
                : 0;

            document.getElementById('potentialRevenue').textContent = formatMAD(potentialRevenue);
            document.getElementById('totalRevenue').textContent = formatMAD(totalRevenue);
            document.getElementById('totalOrders').textContent = ordersData.length;
            document.getElementById('ordersSubtitle').textContent = `${pendingOrders.length} pending`;
            document.getElementById('totalVisitors').textContent = uniqueVisitors.toLocaleString();
            document.getElementById('visitorsSubtitle').textContent = `${allTimeVisitors.toLocaleString()} all time`;
            document.getElementById('conversionRate').textContent = conversionRate + '%';
            document.getElementById('avgOrderValue').textContent = formatMAD(avgOrderValue);
            document.getElementById('onlineNow').textContent = analyticsData?.realtime?.online || 0;
        }

        // Revenue by City
        function renderRevenueByCity() {
            const cityRevenue = {};
            ordersData.forEach(order => {
                const city = order.district?.ville || 'Unknown';
                const amount = parseFloat(order.amount) || 0;
                cityRevenue[city] = (cityRevenue[city] || 0) + amount;
            });

            const sorted = Object.entries(cityRevenue)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 6);

            const maxValue = sorted.length > 0 ? sorted[0][1] : 1;

            const container = document.getElementById('revenueByCity');
            container.innerHTML = sorted.map(([city, revenue]) => `
                <div class="h-bar-item">
                    <div class="h-bar-label">${city}</div>
                    <div class="h-bar-track">
                        <div class="h-bar-fill" style="width: ${(revenue / maxValue * 100)}%">
                            <span class="h-bar-value">${formatMAD(revenue)}</span>
                        </div>
                    </div>
                </div>
            `).join('') || '<p style="color: var(--text-muted);">No data available</p>';
        }

        // Order Status Chart
        function renderOrderStatus() {
            const statusCounts = {};

            ordersData.forEach(order => {
                const status = getStatusName(order.status);
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });

            const total = ordersData.length || 1;
            const colors = {
                'to_prepare': '#eab308', // Yellow
                'ready_to_ship': '#06b6d4', // Cyan
                'in_delivery': '#3b82f6', // Blue
                'shipped': '#8b5cf6', // Purple
                'postponed': '#a855f7', // Light Purple
                'unreachable': '#ec4899', // Pink
                'delivered': '#22c55e', // Green
                'returned': '#f97316', // Orange
                'refused': '#ef4444', // Red
                'rejected': '#991b1b', // Dark Red
                'cancelled': '#ef4444' // Red
            };

            const labels = {
                'to_prepare': '√Ä pr√©parer',
                'ready_to_ship': 'Pr√™t √† exp√©dier',
                'in_delivery': 'En livraison',
                'shipped': 'Exp√©di√©',
                'postponed': 'Report√©',
                'unreachable': 'Injoignable',
                'delivered': 'Livr√©',
                'returned': 'Retourn√©',
                'refused': 'Refus√©',
                'rejected': 'Rejet√©',
                'cancelled': 'Annul√©'
            };

            let offset = 0;
            const circumference = 2 * Math.PI * 60;
            const segments = [];

            // Sort by count desc
            Object.entries(statusCounts)
                .sort((a, b) => b[1] - a[1])
                .forEach(([status, count]) => {
                    if (count > 0) {
                        const percent = count / total;
                        const dash = circumference * percent;
                        segments.push({
                            status,
                            count,
                            color: colors[status] || '#666',
                            label: labels[status] || status,
                            dash,
                            offset: circumference - offset
                        });
                        offset += dash;
                    }
                });

            const container = document.getElementById('orderStatusChart');
            container.innerHTML = `
                <div class="donut-chart">
                    <svg viewBox="0 0 160 160">
                        <circle class="donut-bg" cx="80" cy="80" r="60"></circle>
                        ${segments.map(s => `
                            <circle class="donut-segment" cx="80" cy="80" r="60" 
                                stroke="${s.color}" 
                                stroke-dasharray="${s.dash} ${circumference}" 
                                stroke-dashoffset="${s.offset}">
                            </circle>
                        `).join('')}
                    </svg>
                    <div class="donut-center">
                        <div class="donut-center-value">${total}</div>
                        <div class="donut-center-label">Orders</div>
                    </div>
                </div>
                <div class="donut-legend">
                    ${segments.map(s => `
                        <div class="legend-item">
                            <div class="legend-color" style="background: ${s.color}"></div>
                            <span class="legend-label">${s.label}</span>
                            <span class="legend-value">${s.count} (${((s.count / total) * 100).toFixed(0)}%)</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Product Performance
        function renderProductPerformance() {
            const productStats = {};

            ordersData.forEach(order => {
                if (order.products && Array.isArray(order.products)) {
                    order.products.forEach(product => {
                        const name = product.name || product.code || 'Unknown';
                        const qty = parseInt(product.quantity) || 1;
                        if (!productStats[name]) {
                            productStats[name] = { quantity: 0, orders: 0 };
                        }
                        productStats[name].quantity += qty;
                        productStats[name].orders++;
                    });
                }
            });

            const sorted = Object.entries(productStats)
                .sort((a, b) => b[1].quantity - a[1].quantity);

            const container = document.getElementById('productPerformance');
            container.innerHTML = sorted.map(([name, stats], i) => {
                const shortName = name.substring(0, 25);
                return `
                    <div class="stat-item">
                        <span class="stat-item-label">${i + 1}. ${shortName}</span>
                        <span class="stat-item-value">${stats.quantity} units</span>
                    </div>
                `;
            }).join('') || '<p style="color: var(--text-muted); padding: 20px;">No product data available</p>';
        }

        // Traffic Sources
        function renderTrafficSources() {
            const sources = {};

            if (analyticsData?.topPages) {
                analyticsData.topPages.forEach(page => {
                    const path = page.path || '';
                    let source = 'Direct';

                    if (path.includes('utm_source=fb') || path.includes('utm_source=facebook')) {
                        source = 'Facebook Ads';
                    } else if (path.includes('utm_source=ig') || path.includes('utm_source=instagram')) {
                        source = 'Instagram Ads';
                    } else if (path.includes('utm_source=an')) {
                        source = 'Audience Network';
                    } else if (path.includes('fbclid')) {
                        source = 'Facebook';
                    } else if (path.includes('utm_medium=social')) {
                        source = 'Social Media';
                    }

                    sources[source] = (sources[source] || 0) + (page.views || 0);
                });
            }

            const sorted = Object.entries(sources)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const maxValue = sorted.length > 0 ? sorted[0][1] : 1;

            const container = document.getElementById('trafficSources');
            container.innerHTML = sorted.map(([source, views]) => `
                <div class="h-bar-item">
                    <div class="h-bar-label">${source}</div>
                    <div class="h-bar-track">
                        <div class="h-bar-fill" style="width: ${(views / maxValue * 100)}%; background: linear-gradient(90deg, var(--secondary) 0%, #2e7d32 100%);">
                            <span class="h-bar-value">${views}</span>
                        </div>
                    </div>
                </div>
            `).join('') || '<p style="color: var(--text-muted);">No traffic data available</p>';
        }

        // Device Distribution
        function renderDeviceChart() {
            const devices = analyticsData?.devices || [];
            const total = devices.reduce((sum, d) => sum + d.count, 0) || 1;

            const colors = {
                'Mobile': '#3b82f6',
                'Desktop': '#8b5cf6',
                'Tablet': '#f59e0b'
            };

            const circumference = 2 * Math.PI * 60;
            let offset = 0;
            const segments = [];

            devices.forEach(device => {
                const percent = device.count / total;
                const dash = circumference * percent;
                segments.push({
                    name: device.name,
                    count: device.count,
                    color: colors[device.name] || '#666',
                    dash,
                    offset: circumference - offset
                });
                offset += dash;
            });

            const container = document.getElementById('deviceChart');
            container.innerHTML = `
                <div class="donut-chart">
                    <svg viewBox="0 0 160 160">
                        <circle class="donut-bg" cx="80" cy="80" r="60"></circle>
                        ${segments.map(s => `
                            <circle class="donut-segment" cx="80" cy="80" r="60" 
                                stroke="${s.color}" 
                                stroke-dasharray="${s.dash} ${circumference}" 
                                stroke-dashoffset="${s.offset}">
                            </circle>
                        `).join('')}
                    </svg>
                    <div class="donut-center">
                        <div class="donut-center-value">${total}</div>
                        <div class="donut-center-label">Sessions</div>
                    </div>
                </div>
                <div class="donut-legend">
                    ${segments.map(s => `
                        <div class="legend-item">
                            <div class="legend-color" style="background: ${s.color}"></div>
                            <span class="legend-label">${s.name}</span>
                            <span class="legend-value">${s.count} (${((s.count / total) * 100).toFixed(0)}%)</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Conversion Funnel
        function renderConversionFunnel() {
            const pageViews = {};
            if (analyticsData?.topPages) {
                analyticsData.topPages.forEach(page => {
                    const path = page.path.split('?')[0];
                    pageViews[path] = (pageViews[path] || 0) + page.views;
                });
            }

            const homepage = (pageViews['/'] || 0) + (pageViews['/index.html'] || 0);
            const productPage = pageViews['/product-detail.html'] || 0;
            const cartPage = pageViews['/cart.html'] || 0;
            const checkoutPage = pageViews['/checkout.html'] || 0;
            const confirmationPage = pageViews['/confirmation.html'] || 0;

            const totalVisitors = analyticsData?.summary?.uniqueVisitors || homepage || 1;
            const maxViews = Math.max(homepage, productPage, checkoutPage, totalVisitors);

            const funnel = [
                { label: 'Homepage', value: homepage || totalVisitors, rate: 100 },
                { label: 'Product Views', value: productPage, rate: productPage ? ((productPage / (homepage || totalVisitors)) * 100).toFixed(1) : 0 },
                { label: 'Checkout', value: checkoutPage, rate: checkoutPage ? ((checkoutPage / (productPage || 1)) * 100).toFixed(1) : 0 },
                { label: 'Orders', value: ordersData.length, rate: checkoutPage ? ((ordersData.length / checkoutPage) * 100).toFixed(1) : 0 }
            ];

            const container = document.getElementById('conversionFunnel');
            container.innerHTML = funnel.map((step, i) => `
                <div class="funnel-step">
                    <div class="funnel-bar" style="width: ${Math.max(20, (step.value / maxViews) * 100)}%">
                        <span class="funnel-bar-text">${step.value}</span>
                    </div>
                    <div class="funnel-info">
                        <div class="funnel-label">${step.label}</div>
                        ${i > 0 ? `<div class="funnel-rate">${step.rate}% from previous</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Top Pages
        function renderTopPages() {
            const pageViews = {};
            if (analyticsData?.topPages) {
                analyticsData.topPages.forEach(page => {
                    let path = page.path.split('?')[0];
                    if (path === '/') path = '/index.html';
                    pageViews[path] = (pageViews[path] || 0) + page.views;
                });
            }

            const sorted = Object.entries(pageViews)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const pageNames = {
                '/index.html': 'Homepage',
                '/products.html': 'Collection',
                '/product-detail.html': 'Product Page',
                '/cart.html': 'Shopping Cart',
                '/checkout.html': 'Checkout',
                '/confirmation.html': 'Order Confirmed'
            };

            const container = document.getElementById('topPages');
            container.innerHTML = sorted.map(([path, views]) => `
                <div class="stat-item">
                    <span class="stat-item-label">${pageNames[path] || path}</span>
                    <span class="stat-item-value">${views}</span>
                </div>
            `).join('') || '<p style="color: var(--text-muted); padding: 20px;">No page data available</p>';
        }

        // Customer Insights
        function renderCustomerInsights() {
            const cities = new Set();
            const phones = new Set();

            ordersData.forEach(order => {
                if (order.district?.ville) cities.add(order.district.ville);
                if (order.phone) phones.add(order.phone);
            });

            const repeatCustomers = ordersData.length - phones.size;
            const avgPagesPerSession = analyticsData?.summary?.pagesPerSession?.toFixed(1) || '-';
            const mobilePercent = analyticsData?.devices?.find(d => d.name === 'Mobile')?.percentage || 0;

            const container = document.getElementById('customerInsights');
            container.innerHTML = `
                <div class="metric-item">
                    <div class="metric-value">${phones.size}</div>
                    <div class="metric-label">Unique Customers</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value">${cities.size}</div>
                    <div class="metric-label">Cities Reached</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value">${repeatCustomers}</div>
                    <div class="metric-label">Repeat Orders</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value">${avgPagesPerSession}</div>
                    <div class="metric-label">Pages/Session</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value">${mobilePercent}%</div>
                    <div class="metric-label">Mobile Users</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value">${analyticsData?.browsers?.[0]?.name || '-'}</div>
                    <div class="metric-label">Top Browser</div>
                </div>
            `;
        }

        // Hourly Chart
        function renderHourlyChart() {
            const hourlyViews = analyticsData?.hourlyViews || Array(24).fill(0);
            const maxViews = Math.max(...hourlyViews, 1);
            const currentHour = new Date().getHours();

            const container = document.getElementById('hourlyChart');
            container.innerHTML = hourlyViews.map((views, hour) => {
                const height = (views / maxViews) * 180;
                const isCurrentHour = hour === currentHour;
                return `
                    <div class="bar-item">
                        <div class="bar-value">${views || ''}</div>
                        <div class="bar" style="height: ${Math.max(height, 4)}px; ${isCurrentHour ? 'background: linear-gradient(180deg, var(--accent) 0%, #b8962f 100%);' : ''}"></div>
                        <div class="bar-label">${hour.toString().padStart(2, '0')}h</div>
                    </div>
                `;
            }).join('');
        }

        // Recent Orders Table
        function renderRecentOrders() {
            const recent = ordersData.slice(0, 10);

            const statusLabels = {
                'to_prepare': '√Ä pr√©parer',
                'ready_to_ship': 'Pr√™t √† exp√©dier',
                'in_delivery': 'En livraison',
                'shipped': 'Exp√©di√©',
                'postponed': 'Report√©',
                'unreachable': 'Injoignable',
                'delivered': 'Livr√©',
                'returned': 'Retourn√©',
                'refused': 'Refus√©',
                'rejected': 'Rejet√©',
                'cancelled': 'Annul√©'
            };

            const statusColors = {
                'to_prepare': '#eab308',
                'ready_to_ship': '#06b6d4',
                'in_delivery': '#3b82f6',
                'shipped': '#8b5cf6',
                'postponed': '#a855f7',
                'unreachable': '#ec4899',
                'delivered': '#22c55e',
                'returned': '#f97316',
                'refused': '#ef4444',
                'rejected': '#991b1b',
                'cancelled': '#ef4444'
            };

            const tbody = document.getElementById('recentOrdersBody');
            tbody.innerHTML = recent.map(order => {
                const status = getStatusName(order.status);
                const products = order.products?.map(p => `${p.name?.split(' ').slice(0, 2).join(' ') || p.code} (√ó${p.quantity})`).join(', ') || '-';
                return `
                    <tr>
                        <td><strong>${order.code}</strong></td>
                        <td>${order.name}</td>
                        <td>${order.district?.ville || '-'}</td>
                        <td style="font-weight: 600; color: var(--accent);">${formatMAD(parseFloat(order.amount))}</td>
                        <td><span style="padding: 4px 10px; background: ${statusColors[status] || '#666'}20; color: ${statusColors[status] || '#666'}; border-radius: 12px; font-size: 0.8rem;">${statusLabels[status] || status}</span></td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${products}</td>
                    </tr>
                `;
            }).join('') || '<tr><td colspan="6" style="text-align: center;">No orders available</td></tr>';
        }
    </script>
</body>

</html>